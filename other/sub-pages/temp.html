<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pandemic Simulation Map</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
          crossorigin=""/>
    
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: Arial, sans-serif;
            overflow: hidden;
        }
        
        #map {
            position: absolute;
            top: 0;
            bottom: 0;
            left: 0;
            right: 0;
            z-index: 1;
        }
        
        /* Game UI overlay container */
        #game-ui {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            pointer-events: none;
            z-index: 1000;
        }
        
        /* Control panel */
        .control-panel {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 20px;
            border-radius: 10px;
            pointer-events: auto;
            min-width: 250px;
        }
        
        .control-panel h3 {
            margin: 0 0 15px 0;
            font-size: 18px;
            border-bottom: 1px solid #555;
            padding-bottom: 10px;
        }
        
        .stat-row {
            display: flex;
            justify-content: space-between;
            margin: 8px 0;
            font-size: 14px;
        }
        
        .stat-value {
            font-weight: bold;
        }
        
        .stat-value.healthy { color: #4CAF50; }
        .stat-value.infected { color: #ff6b6b; }
        .stat-value.dead { color: #666; }
        
        .control-button {
            width: 100%;
            padding: 10px;
            margin-top: 15px;
            background: #0066cc;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
        }
        
        .control-button:hover {
            background: #0052a3;
        }
        
        .control-button.pause {
            background: #ff6b6b;
        }
        
        .control-button.pause:hover {
            background: #ff5252;
        }
        
        /* Game title */
        .game-title {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 10px 20px;
            border-radius: 5px;
            pointer-events: auto;
            font-size: 24px;
            font-weight: bold;
        }
        
        .loading-indicator {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 20px 40px;
            border-radius: 10px;
            font-size: 18px;
            z-index: 2000;
            text-align: center;
        }
        
        /* Custom map controls styling */
        .leaflet-control-zoom {
            margin: 20px;
        }
        
        /* Enhanced popup styling */
        .country-popup {
            min-width: 300px;
            max-width: 350px;
        }
        
        .country-popup h3 {
            margin: 0 0 15px 0;
            font-size: 22px;
            display: flex;
            align-items: center;
            gap: 12px;
            border-bottom: 2px solid #e0e0e0;
            padding-bottom: 10px;
        }
        
        .country-popup .flag {
            width: 48px;
            height: 32px;
            object-fit: cover;
            border: 1px solid #ddd;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .country-popup .pandemic-stats {
            background: #f5f5f5;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
        }
        
        .country-popup .pandemic-stats h4 {
            margin: 0 0 10px 0;
            font-size: 16px;
            color: #333;
        }
        
        .country-popup .stat-bar {
            height: 30px;
            background: #e0e0e0;
            border-radius: 15px;
            overflow: hidden;
            display: flex;
            margin: 10px 0;
        }
        
        .country-popup .stat-bar .healthy-bar {
            background: #4CAF50;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 12px;
            font-weight: bold;
        }
        
        .country-popup .stat-bar .infected-bar {
            background: #ff6b6b;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 12px;
            font-weight: bold;
        }
        
        .country-popup .stat-bar .dead-bar {
            background: #666;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 12px;
            font-weight: bold;
        }
        
        .speed-controls {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #555;
        }
        
        .speed-label {
            font-size: 12px;
            margin-bottom: 5px;
        }
        
        .speed-slider {
            width: 100%;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <!-- Map container -->
    <div id="map"></div>
    
    <!-- Loading indicator -->
    <div id="loading" class="loading-indicator">
        Loading country data...
        <div class="progress">Fetching country information from API...</div>
    </div>
    
    <!-- Game UI overlay container -->
    <div id="game-ui">
        <div class="game-title">Pandemic Simulator</div>
        
        <div class="control-panel">
            <h3>Global Statistics</h3>
            <div class="stat-row">
                <span>Healthy:</span>
                <span class="stat-value healthy" id="global-healthy">0</span>
            </div>
            <div class="stat-row">
                <span>Infected:</span>
                <span class="stat-value infected" id="global-infected">0</span>
            </div>
            <div class="stat-row">
                <span>Dead:</span>
                <span class="stat-value dead" id="global-dead">0</span>
            </div>
            <div class="stat-row" style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #555;">
                <span>Day:</span>
                <span class="stat-value" id="day-counter">0</span>
            </div>
            
            <button class="control-button" id="pause-button" onclick="game.togglePause()">
                Pause Simulation
            </button>
            <button class="control-button" onclick="game.resetSimulation()">
                Reset Simulation
            </button>
            
            <div class="speed-controls">
                <div class="speed-label">Simulation Speed: <span id="speed-value">1</span>x</div>
                <input type="range" class="speed-slider" id="speed-slider" 
                       min="0.25" max="5" step="0.25" value="1"
                       oninput="game.setSimulationSpeed(this.value)">
            </div>
        </div>
    </div>
    
    <!-- Leaflet JavaScript -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
            integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
            crossorigin=""></script>
    
    <script>
        // ===== PANDEMIC SIMULATION CONSTANTS =====
        const INFECTION_RATE_SAME_COUNTRY = 0.03;     // 3% chance per infected per day
        const INFECTION_RATE_ADJACENT = 0.001;        // 0.1% chance per infected for adjacent countries
        const RECOVERY_RATE = 0.10;                   // 10% chance of recovery per day
        const DEATH_RATE = 0.02;                      // 2% chance of death per day
        const INITIAL_INFECTION_PERCENTAGE = 0.001;   // 0.1% of population initially infected
        
        // Country adjacency map (simplified - add more as needed)
        const countryAdjacency = {
            "United States": ["Canada", "Mexico"],
            "Canada": ["United States"],
            "Mexico": ["United States", "Guatemala", "Belize"],
            "Brazil": ["Argentina", "Bolivia", "Colombia", "French Guiana", "Guyana", "Paraguay", "Peru", "Suriname", "Uruguay", "Venezuela"],
            "Argentina": ["Brazil", "Bolivia", "Chile", "Paraguay", "Uruguay"],
            "France": ["Spain", "Italy", "Switzerland", "Germany", "Belgium", "Luxembourg"],
            "Germany": ["France", "Switzerland", "Austria", "Czech Republic", "Poland", "Denmark", "Netherlands", "Belgium", "Luxembourg"],
            "Spain": ["France", "Portugal"],
            "Italy": ["France", "Switzerland", "Austria", "Slovenia"],
            "Poland": ["Germany", "Czech Republic", "Slovakia", "Ukraine", "Belarus", "Lithuania", "Russia"],
            "Russia": ["Finland", "Estonia", "Latvia", "Lithuania", "Poland", "Belarus", "Ukraine", "Georgia", "Azerbaijan", "Kazakhstan", "China", "Mongolia", "North Korea"],
            "China": ["Russia", "Mongolia", "North Korea", "Vietnam", "Laos", "Myanmar", "India", "Bhutan", "Nepal", "Pakistan", "Afghanistan", "Tajikistan", "Kyrgyzstan", "Kazakhstan"],
            "India": ["Pakistan", "China", "Nepal", "Bhutan", "Bangladesh", "Myanmar"],
            "United Kingdom": ["Ireland"],
            "Ireland": ["United Kingdom"],
            // Add more adjacencies as needed
        };
        
        // Cache for country data from API
        const countryDataCache = {};
        
        // Initialize the map
        const map = L.map('map', {
            center: [20, 0],
            zoom: 3,
            minZoom: 2,
            maxZoom: 18,
            worldCopyJump: true,
            zoomControl: true
        });
        
        // Add OpenStreetMap tiles
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
            noWrap: false
        }).addTo(map);
        
        // Set max bounds
        const southWest = L.latLng(-89.98155760646617, -180);
        const northEast = L.latLng(89.99346179538875, 180);
        const bounds = L.latLngBounds(southWest, northEast);
        map.setMaxBounds(bounds);
        map.on('drag', function() {
            map.panInsideBounds(bounds, { animate: false });
        });
        
        // Utility functions
        function formatNumber(num) {
            if (num >= 1e9) return (num / 1e9).toFixed(2) + 'B';
            if (num >= 1e6) return (num / 1e6).toFixed(1) + 'M';
            if (num >= 1e3) return (num / 1e3).toFixed(1) + 'K';
            return Math.round(num).toString();
        }
        
        // Fetch country data from REST Countries API
        async function fetchCountryData() {
            try {
                const response = await fetch('https://restcountries.com/v3.1/all?fields=name,population,languages,flags,region,subregion,capital,area,cca2,cca3');
                const data = await response.json();
                
                data.forEach(country => {
                    const commonName = country.name.common;
                    const languages = country.languages ? Object.values(country.languages).slice(0, 3).join(', ') : 'N/A';
                    
                    countryDataCache[commonName] = {
                        population: country.population,
                        populationFormatted: formatNumber(country.population),
                        languages: languages,
                        flag: country.flags.png || country.flags.svg,
                        region: country.region,
                        subregion: country.subregion,
                        capital: country.capital ? country.capital[0] : 'N/A',
                        area: country.area ? formatNumber(country.area) + ' km¬≤' : 'N/A'
                    };
                });
                
                // Manual mappings
                countryDataCache['United States of America'] = countryDataCache['United States'];
                countryDataCache['USA'] = countryDataCache['United States'];
                countryDataCache['UK'] = countryDataCache['United Kingdom'];
                
            } catch (error) {
                console.error('Error fetching country data:', error);
            }
        }
        
        // Game object
        const game = {
            countryLayers: [],
            countryData: {},
            pandemicData: {},
            simulationRunning: false,
            simulationSpeed: 1,
            dayCounter: 0,
            simulationInterval: null,
            
            // Initialize pandemic data for a country
            initializePandemicData: function(countryName, population) {
                this.pandemicData[countryName] = {
                    healthy: population,
                    infected: 0,
                    dead: 0,
                    totalPopulation: population
                };
            },
            
            // Start the pandemic in a random country
            startPandemic: function() {
                const countries = Object.keys(this.pandemicData);
                if (countries.length === 0) return;
                
                // Pick a random country
                const patientZeroCountry = countries[Math.floor(Math.random() * countries.length)];
                const data = this.pandemicData[patientZeroCountry];
                
                // Infect initial percentage
                const initialInfected = Math.max(1, Math.floor(data.totalPopulation * INITIAL_INFECTION_PERCENTAGE));
                data.infected = initialInfected;
                data.healthy = data.totalPopulation - initialInfected;
                
                console.log(`Pandemic started in ${patientZeroCountry} with ${initialInfected} infected`);
                
                // Start simulation
                this.simulationRunning = true;
                this.startSimulation();
            },
            
            // Simulation step
            simulateDay: function() {
                if (!this.simulationRunning) return;
                
                this.dayCounter++;
                
                // Create a copy of pandemic data to work with
                const newData = {};
                Object.keys(this.pandemicData).forEach(country => {
                    newData[country] = { ...this.pandemicData[country] };
                });
                
                // Process each country
                Object.keys(this.pandemicData).forEach(countryName => {
                    const data = this.pandemicData[countryName];
                    if (data.infected === 0) return;
                    
                    // Calculate new infections within country
                    const infectionProbability = 1 - Math.pow(1 - INFECTION_RATE_SAME_COUNTRY, data.infected);
                    const newInfections = Math.min(
                        data.healthy,
                        Math.floor(data.healthy * infectionProbability)
                    );
                    
                    // Calculate recoveries
                    const recoveries = Math.floor(data.infected * RECOVERY_RATE);
                    
                    // Calculate deaths
                    const deaths = Math.floor(data.infected * DEATH_RATE);
                    
                    // Update country data
                    newData[countryName].healthy = data.healthy - newInfections;
                    newData[countryName].infected = data.infected + newInfections - recoveries - deaths;
                    newData[countryName].dead = data.dead + deaths;
                    
                    // Infect adjacent countries
                    const adjacentCountries = countryAdjacency[countryName] || [];
                    adjacentCountries.forEach(adjacentCountry => {
                        if (this.pandemicData[adjacentCountry] && this.pandemicData[adjacentCountry].healthy > 0) {
                            const crossBorderProbability = 1 - Math.pow(1 - INFECTION_RATE_ADJACENT, data.infected);
                            const crossBorderInfections = Math.floor(
                                this.pandemicData[adjacentCountry].healthy * crossBorderProbability
                            );
                            if (crossBorderInfections > 0) {
                                newData[adjacentCountry].healthy -= crossBorderInfections;
                                newData[adjacentCountry].infected += crossBorderInfections;
                            }
                        }
                    });
                });
                
                // Apply new data
                this.pandemicData = newData;
                
                // Update visualization
                this.updateVisualization();
                this.updateGlobalStats();
            },
            
            // Update country colors based on infection rate
            updateVisualization: function() {
                Object.keys(this.countryData).forEach(countryName => {
                    const pandemicData = this.pandemicData[countryName];
                    if (!pandemicData) return;
                    
                    const infectionRate = pandemicData.infected / pandemicData.totalPopulation;
                    const opacity = Math.min(0.8, infectionRate * 10); // Scale up for visibility
                    
                    const layer = this.countryData[countryName].layer;
                    if (layer) {
                        layer.setStyle({
                            fillOpacity: opacity
                        });
                    }
                });
            },
            
            // Update global statistics
            updateGlobalStats: function() {
                let totalHealthy = 0, totalInfected = 0, totalDead = 0;
                
                Object.values(this.pandemicData).forEach(data => {
                    totalHealthy += data.healthy;
                    totalInfected += data.infected;
                    totalDead += data.dead;
                });
                
                document.getElementById('global-healthy').textContent = formatNumber(totalHealthy);
                document.getElementById('global-infected').textContent = formatNumber(totalInfected);
                document.getElementById('global-dead').textContent = formatNumber(totalDead);
                document.getElementById('day-counter').textContent = this.dayCounter;
            },
            
            // Start simulation loop
            startSimulation: function() {
                if (this.simulationInterval) clearInterval(this.simulationInterval);
                
                this.simulationInterval = setInterval(() => {
                    this.simulateDay();
                }, 1000 / this.simulationSpeed);
            },
            
            // Toggle pause
            togglePause: function() {
                this.simulationRunning = !this.simulationRunning;
                const button = document.getElementById('pause-button');
                
                if (this.simulationRunning) {
                    button.textContent = 'Pause Simulation';
                    button.classList.remove('pause');
                    this.startSimulation();
                } else {
                    button.textContent = 'Resume Simulation';
                    button.classList.add('pause');
                    if (this.simulationInterval) {
                        clearInterval(this.simulationInterval);
                    }
                }
            },
            
            // Set simulation speed
            setSimulationSpeed: function(speed) {
                this.simulationSpeed = parseFloat(speed);
                document.getElementById('speed-value').textContent = speed;
                
                if (this.simulationRunning) {
                    this.startSimulation();
                }
            },
            
            // Reset simulation
            resetSimulation: function() {
                this.simulationRunning = false;
                this.dayCounter = 0;
                
                if (this.simulationInterval) {
                    clearInterval(this.simulationInterval);
                }
                
                // Reset pandemic data
                Object.keys(this.pandemicData).forEach(country => {
                    const population = this.pandemicData[country].totalPopulation;
                    this.initializePandemicData(country, population);
                });
                
                // Reset visualization
                this.updateVisualization();
                this.updateGlobalStats();
                
                // Reset button
                const button = document.getElementById('pause-button');
                button.textContent = 'Start Simulation';
                button.classList.remove('pause');
                
                // Restart pandemic
                setTimeout(() => this.startPandemic(), 100);
            },
            
            // Create enhanced popup content
            createPopupContent: function(countryName) {
                const info = countryDataCache[countryName] || {
                    populationFormatted: "N/A",
                    flag: null,
                    capital: "N/A"
                };
                
                const pandemicData = this.pandemicData[countryName] || {
                    healthy: 0,
                    infected: 0,
                    dead: 0,
                    totalPopulation: 1
                };
                
                const healthyPercent = (pandemicData.healthy / pandemicData.totalPopulation * 100).toFixed(1);
                const infectedPercent = (pandemicData.infected / pandemicData.totalPopulation * 100).toFixed(1);
                const deadPercent = (pandemicData.dead / pandemicData.totalPopulation * 100).toFixed(1);
                
                return `
                    <div class="country-popup">
                        <h3>
                            ${info.flag ? `<img src="${info.flag}" alt="${countryName} flag" class="flag">` : 'üè≥Ô∏è'}
                            ${countryName}
                        </h3>
                        
                        <div class="pandemic-stats">
                            <h4>Pandemic Status - Day ${this.dayCounter}</h4>
                            
                            <div class="stat-bar">
                                ${healthyPercent > 0 ? `<div class="healthy-bar" style="width: ${healthyPercent}%">${healthyPercent}%</div>` : ''}
                                ${infectedPercent > 0 ? `<div class="infected-bar" style="width: ${infectedPercent}%">${infectedPercent}%</div>` : ''}
                                ${deadPercent > 0 ? `<div class="dead-bar" style="width: ${deadPercent}%">${deadPercent}%</div>` : ''}
                            </div>
                            
                            <div style="margin-top: 10px; font-size: 14px;">
                                <div style="color: #4CAF50;">Healthy: ${formatNumber(pandemicData.healthy)}</div>
                                <div style="color: #ff6b6b;">Infected: ${formatNumber(pandemicData.infected)}</div>
                                <div style="color: #666;">Dead: ${formatNumber(pandemicData.dead)}</div>
                            </div>
                        </div>
                        
                        <div style="font-size: 14px; margin-top: 10px;">
                            <div><strong>Capital:</strong> ${info.capital}</div>
                            <div><strong>Total Population:</strong> ${info.populationFormatted}</div>
                        </div>
                    </div>
                `;
            },
            
            // Load and display countries
            loadCountries: async function() {
                try {
                    // Fetch country data from API
                    await fetchCountryData();
                    
                    // Fetch country boundaries
                    const response = await fetch('https://raw.githubusercontent.com/johan/world.geo.json/master/countries.geo.json');
                    const data = await response.json();
                    
                    // Create layers for each country
                    data.features.forEach(feature => {
                        const countryName = feature.properties.name;
                        
                        // Initialize pandemic data
                        const countryInfo = countryDataCache[countryName];
                        const population = countryInfo ? countryInfo.population : 1000000; // Default 1M if unknown
                        this.initializePandemicData(countryName, population);
                        
                        // Store country data
                        this.countryData[countryName] = {
                            feature: feature
                        };
                        
                        // Create country layer
                        const countryLayer = L.geoJSON(feature, {
                            style: {
                                fillColor: '#ff0000',
                                fillOpacity: 0,
                                color: '#cc0000',
                                weight: 1,
                                opacity: 0.3
                            },
                            onEachFeature: (feature, layer) => {
                                layer.on({
                                    mouseover: (e) => {
                                        const layer = e.target;
                                        layer.setStyle({
                                            weight: 2,
                                            color: '#ff0000',
                                            opacity: 0.7
                                        });
                                        layer.bringToFront();
                                    },
                                    mouseout: (e) => {
                                        const layer = e.target;
                                        layer.setStyle({
                                            weight: 1,
                                            color: '#cc0000',
                                            opacity: 0.3
                                        });
                                    },
                                    click: (e) => {
                                        L.popup({
                                            maxWidth: 350
                                        })
                                            .setLatLng(e.latlng)
                                            .setContent(this.createPopupContent(countryName))
                                            .openOn(map);
                                    }
                                });
                            }
                        }).addTo(map);
                        
                        this.countryData[countryName].layer = countryLayer;
                        this.countryLayers.push(countryLayer);
                    });
                    
                    // Hide loading indicator
                    document.getElementById('loading').style.display = 'none';
                    
                    // Update initial stats
                    this.updateGlobalStats();
                    
                    // Start pandemic after a delay
                    setTimeout(() => this.startPandemic(), 1000);
                    
                } catch (error) {
                    console.error('Error loading country data:', error);
                    document.getElementById('loading').innerHTML = 'Error loading map data. Please refresh.';
                }
            }
        };
        
        // Load countries when page loads
        game.loadCountries();
        
        // Expose game object globally
        window.game = game;
        
        // Add keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            if (e.key === ' ') {
                e.preventDefault();
                game.togglePause();
            } else if (e.key === 'r' || e.key === 'R') {
                game.resetSimulation();
            }
        });
    </script>
</body>
</html>